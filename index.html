<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>الطلبيات</title>
  <style>
    body{font-family:system-ui,Tahoma,Arial;margin:0;background:#fafafa;color:#111}
    .wrap{max-width:1100px;margin:auto;padding:16px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:12px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e7e7e7;border-radius:14px;padding:12px}
    .btn{border:1px solid #e7e7e7;background:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    input{padding:10px;border:1px solid #e7e7e7;border-radius:10px;width:220px;max-width:100%}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:right;vertical-align:top}
    th{color:#666;font-weight:600;font-size:13px}
    .muted{color:#666;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .orderItem{border:1px solid #e7e7e7;border-radius:12px;padding:10px;cursor:pointer;display:flex;justify-content:space-between}
    .orderItem.active{border-color:#111}
    .thumbs{display:flex;gap:6px;flex-wrap:wrap}
    .thumbs img{width:44px;height:44px;object-fit:cover;border-radius:10px;border:1px solid #eee}
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <div>
      <b style="font-size:20px">نظام طلبيات بسيط</b>
      <div class="muted">نسخة مشتركة: أي شخص عنده الرابط يشوف نفس البيانات.</div>
    </div>
    <button class="btn primary" id="newOrderBtn">+ طلبية جديدة (اليوم)</button>
  </div>

  <div class="grid" style="margin-top:12px">
    <aside class="card">
      <b>الطلبيات</b>
      <div class="muted" id="ordersMsg" style="margin:8px 0"></div>
      <div id="ordersList"></div>
    </aside>

    <main class="card">
      <div id="mainEmpty" class="muted">اختاري طلبية…</div>

      <div id="main" style="display:none">
        <div class="row" style="justify-content:space-between">
          <div>
            <b id="activeOrderTitle"></b>
            <div class="muted" id="activeOrderMeta"></div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:12px 0">

        <b>إضافة شراء</b>
        <div class="muted">حتى 5 روابط + 10 صور</div>

        <div class="row" style="margin-top:10px">
          <input id="itemName" placeholder="اسم الشراء" />
          <input id="price" type="number" step="0.01" min="0" placeholder="السعر" />
          <input id="qty" type="number" step="1" min="1" value="1" placeholder="العدد" />
        </div>

        <div class="row" style="margin-top:10px" id="links"></div>

        <div class="row" style="margin-top:10px">
          <input id="images" type="file" accept="image/*" multiple />
          <button class="btn primary" id="addPurchaseBtn">إضافة</button>
          <span class="muted" id="formMsg"></span>
        </div>

        <hr style="border:none;border-top:1px solid #eee;margin:12px 0">

        <b>المشتريات</b>
        <div style="overflow:auto;margin-top:8px">
          <table>
            <thead>
              <tr>
                <th>الاسم</th><th>السعر</th><th>العدد</th><th>روابط</th><th>صور</th>
              </tr>
            </thead>
            <tbody id="purchasesBody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Supabase JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // 1) Configure
  const SUPABASE_URL = "https://maucjvxhrnkdeybltjco.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_0N65DXPMsk_3WVcLQ9wavQ_p9HgB_Bo";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const BUCKET = "purchase-images";

  // UI refs
  const ordersList = document.getElementById("ordersList");
  const ordersMsg = document.getElementById("ordersMsg");
  const newOrderBtn = document.getElementById("newOrderBtn");

  const mainEmpty = document.getElementById("mainEmpty");
  const main = document.getElementById("main");
  const activeOrderTitle = document.getElementById("activeOrderTitle");
  const activeOrderMeta = document.getElementById("activeOrderMeta");

  const itemName = document.getElementById("itemName");
  const price = document.getElementById("price");
  const qty = document.getElementById("qty");
  const images = document.getElementById("images");
  const linksWrap = document.getElementById("links");
  const addPurchaseBtn = document.getElementById("addPurchaseBtn");
  const formMsg = document.getElementById("formMsg");
  const purchasesBody = document.getElementById("purchasesBody");

  let activeOrderId = null;

  function todayLabel(d=new Date()){
    return `طلبية ${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
  }
  function todayDateISO(d=new Date()){
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function renderLinkInputs(){
    linksWrap.innerHTML = "";
    for(let i=1;i<=5;i++){
      const input = document.createElement("input");
      input.placeholder = `رابط ${i} (اختياري)`;
      input.dataset.link = i;
      linksWrap.appendChild(input);
    }
  }

  async function loadOrders(){
    ordersMsg.textContent = "جاري التحميل...";
    const { data, error } = await sb
      .from("orders")
      .select("id, order_name, created_at, purchases:purchases(count)")
      .order("created_at", { ascending: false });

    if(error){
      ordersMsg.textContent = "صار خطأ بتحميل الطلبيات.";
      console.error(error);
      return;
    }

    ordersMsg.textContent = data.length ? "" : "ما في طلبيات.";
    ordersList.innerHTML = "";

    data.forEach(o=>{
      const div = document.createElement("div");
      div.className = "orderItem" + (o.id === activeOrderId ? " active" : "");
      const count = o.purchases?.[0]?.count ?? 0;
      div.innerHTML = `<div><b>${o.order_name}</b><div class="muted">عدد المشتريات: ${count}</div></div><div class="muted">${count}</div>`;
      div.onclick = () => { activeOrderId = o.id; showOrder(o); };
      ordersList.appendChild(div);
    });

    // auto select first
    if(!activeOrderId && data[0]){
      activeOrderId = data[0].id;
      showOrder(data[0]);
      await loadPurchases();
      await loadOrders(); // refresh active highlight
    }
  }

  function showOrder(order){
    mainEmpty.style.display = "none";
    main.style.display = "";
    activeOrderTitle.textContent = order.order_name;
    activeOrderMeta.textContent = new Date(order.created_at).toLocaleString("ar");
    loadPurchases();
    loadOrders(); // refresh highlight
  }

  async function loadPurchases(){
    if(!activeOrderId) return;
    purchasesBody.innerHTML = `<tr><td colspan="5" class="muted">جاري التحميل...</td></tr>`;

    const { data, error } = await sb
      .from("purchases")
      .select(`
        id, item_name, price, qty, created_at,
        purchase_links(url),
        purchase_images(storage_path)
      `)
      .eq("order_id", activeOrderId)
      .order("created_at", { ascending: false });

    if(error){
      purchasesBody.innerHTML = `<tr><td colspan="5" class="muted">صار خطأ.</td></tr>`;
      console.error(error);
      return;
    }

    if(!data.length){
      purchasesBody.innerHTML = `<tr><td colspan="5" class="muted">ما في مشتريات.</td></tr>`;
      return;
    }

    purchasesBody.innerHTML = "";
    data.forEach(p=>{
      const links = (p.purchase_links || []).slice(0,5);
      const imgs = (p.purchase_images || []).slice(0,10);

      const linksHtml = links.length
        ? links.map((l,i)=>`<div><a href="${escapeAttr(l.url)}" target="_blank" rel="noopener">رابط ${i+1}</a></div>`).join("")
        : `<span class="muted">—</span>`;

      const thumbs = imgs.length
        ? `<div class="thumbs">${imgs.map(x=>{
            const url = sb.storage.from(BUCKET).getPublicUrl(x.storage_path).data.publicUrl;
            return `<img src="${escapeAttr(url)}" alt="صورة">`;
          }).join("")}</div>`
        : `<span class="muted">—</span>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(p.item_name)}</td>
        <td>${Number(p.price).toLocaleString("ar",{maximumFractionDigits:2})}</td>
        <td>${p.qty}</td>
        <td>${linksHtml}</td>
        <td>${thumbs}</td>
      `;
      purchasesBody.appendChild(tr);
    });
  }

  function escapeHtml(s=""){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function escapeAttr(s=""){ return escapeHtml(s); }

  newOrderBtn.onclick = async () => {
    const order_name = todayLabel();
    const order_date = todayDateISO();

    const { data, error } = await sb
      .from("orders")
      .insert({ order_name, order_date })
      .select("id, order_name, created_at")
      .single();

    if(error){
      alert("ما قدرنا نعمل طلبية جديدة.");
      console.error(error);
      return;
    }

    activeOrderId = data.id;
    showOrder(data);
    await loadOrders();
  };

  addPurchaseBtn.onclick = async () => {
    formMsg.textContent = "";

    if(!activeOrderId){ formMsg.textContent = "اختاري طلبية."; return; }

    const name = itemName.value.trim();
    const pr = Number(price.value);
    const q = Number(qty.value);

    if(!name){ formMsg.textContent = "اسم الشراء مطلوب."; return; }
    if(!Number.isFinite(pr) || pr < 0){ formMsg.textContent = "السعر غير صحيح."; return; }
    if(!Number.isFinite(q) || q < 1){ formMsg.textContent = "العدد غير صحيح."; return; }

    // Insert purchase
    const { data: purchase, error: pErr } = await sb
      .from("purchases")
      .insert({ order_id: activeOrderId, item_name: name, price: pr, qty: q })
      .select("id")
      .single();

    if(pErr){
      formMsg.textContent = "فشل إضافة الشراء.";
      console.error(pErr);
      return;
    }

    // Links
    const linkInputs = [...linksWrap.querySelectorAll("input[data-link]")];
    const urls = linkInputs.map(i=>i.value.trim()).filter(Boolean).slice(0,5);
    if(urls.length){
      const rows = urls.map(url => ({ purchase_id: purchase.id, url }));
      const { error } = await sb.from("purchase_links").insert(rows);
      if(error) console.error(error);
    }

    // Images (up to 10)
    const files = [...(images.files || [])].slice(0,10);
    for(const f of files){
      if(!f.type.startsWith("image/")) continue;
      // path: orderId/purchaseId/filename
      const safeName = `${Date.now()}-${f.name}`.replace(/\s+/g,"_");
      const path = `${activeOrderId}/${purchase.id}/${safeName}`;

      const { error: upErr } = await sb.storage.from(BUCKET).upload(path, f);
      if(upErr){
        console.error(upErr);
        continue;
      }
      const { error: imgErr } = await sb.from("purchase_images").insert({
        purchase_id: purchase.id,
        storage_path: path
      });
      if(imgErr) console.error(imgErr);
    }

    // reset form
    itemName.value = ""; price.value = ""; qty.value = 1;
    linkInputs.forEach(i=>i.value=""); images.value="";
    await loadPurchases();
    await loadOrders();
  };

  // init
  renderLinkInputs();
  loadOrders();
</script>
</body>
</html>
