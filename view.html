<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>عرض الطلبية</title>

  <style>
    body{font-family:system-ui,Tahoma,Arial;margin:0;background:#fafafa}
    .wrap{max-width:900px;margin:auto;padding:16px}
    .card{background:#fff;border:1px solid #e7e7e7;border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .btn{border:1px solid #e7e7e7;background:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}
    .thumbs img{width:90px;height:90px;object-fit:cover;border-radius:12px;border:1px solid #eee;cursor:pointer}
    .nav{display:flex;justify-content:space-between;margin:12px 0}
    #lightbox{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center}
    #lightbox img{max-width:90vw;max-height:90vh;border-radius:16px}
  </style>
</head>
<body>

<div class="wrap">
  <div class="row" style="margin-bottom:12px">
    <a class="btn" href="./index.html">رجوع</a>
    <button class="btn" id="logoutBtn">تسجيل خروج</button>
  </div>

  <div class="card">
    <b id="title"></b>

    <div class="nav">
      <button class="btn" id="prev">→</button>
      <span id="counter"></span>
      <button class="btn" id="next">←</button>
    </div>

    <div id="content"></div>
  </div>
</div>

<div id="lightbox"><img></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://maucjvxhrnkdeybltjco.supabase.co";
const SUPABASE_ANON_KEY="sb_publishable_0N65DXPMsk_3WVcLQ9wavQ_p9HgB_Bo";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
const BUCKET="purchase-images";

/* ===== Auth guard ===== */
async function requireAuth(){
  const { data } = await sb.auth.getSession();
  if(!data.session){
    window.location.href="./login.html?next=view.html";
  }
}
requireAuth();

document.getElementById("logoutBtn").onclick=async()=>{
  await sb.auth.signOut();
  window.location.href="./login.html";
};

const title=document.getElementById("title");
const content=document.getElementById("content");
const counter=document.getElementById("counter");
const prev=document.getElementById("prev");
const next=document.getElementById("next");
const lb=document.getElementById("lightbox");
const lbImg=lb.querySelector("img");

let purchases=[],idx=0;

async function init(){
  const { data:orders }=await sb.from("orders").select("*").order("created_at",{ascending:false}).limit(1);
  if(!orders.length)return;
  title.textContent=orders[0].order_name;

  const { data }=await sb
    .from("purchases")
    .select("*,purchase_links(url),purchase_images(storage_path)")
    .eq("order_id",orders[0].id)
    .order("created_at",{ascending:false});

  purchases=data;
  render();
}

function render(){
  if(!purchases.length)return;
  const p=purchases[idx];
  counter.textContent=`${idx+1}/${purchases.length}`;

  const imgs=(p.purchase_images||[]).map(i=>{
    const url=sb.storage.from(BUCKET).getPublicUrl(i.storage_path).data.publicUrl;
    return `<img src="${url}">`;
  }).join("");

  content.innerHTML=`
    <div><b>الزبون:</b> ${p.customer_name}</div>
    <div><b>السعر:</b> ${p.price}</div>
    <div><b>العدد:</b> ${p.qty}</div>
    <div>${(p.purchase_links||[]).map(l=>`<a href="${l.url}" target="_blank">رابط</a>`).join("<br>")}</div>
    <div class="thumbs">${imgs}</div>
  `;

  content.querySelectorAll("img").forEach(img=>{
    img.onclick=()=>{
      lb.style.display="flex";
      lbImg.src=img.src;
    };
  });
}

prev.onclick=()=>{idx=(idx-1+purchases.length)%purchases.length;render();};
next.onclick=()=>{idx=(idx+1)%purchases.length;render();};
lb.onclick=()=>lb.style.display="none";

init();
</script>
</body>
</html>
